import boto3

def lambda_handler(event, context):
    ec2 = boto3.client("ec2")

    # Describe all running instances
    response = ec2.describe_instances(
        Filters=[{"Name": "instance-state-name", "Values": ["pending", "running", "stopping", "stopped"]}]
    )

    instances_to_terminate = []

    for reservation in response["Reservations"]:
        for instance in reservation["Instances"]:
            instance_id = instance["InstanceId"]

            # Get tags as a dictionary
            tags = {tag["Key"]: tag["Value"] for tag in instance.get("Tags", [])}

            # Check if Owner=SDH is missing or mismatched
            if tags.get("Owner") != "SDH":
                instances_to_terminate.append(instance_id)

    if instances_to_terminate:
        print(f"Terminating instances: {instances_to_terminate}")
        ec2.terminate_instances(InstanceIds=instances_to_terminate)
    else:
        print("No instances found that need termination.")

    return {
        "statusCode": 200,
        "body": f"Checked instances. Terminated: {instances_to_terminate}"
    }
